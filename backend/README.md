### エラー処理の扱い

#### 前提
クリーンアーキテクチャに従い、FastifyのsetErrorHandler()による全体エラー処理は今回は採用しない

#### 方針

- ドメイン・インフラ層は、責任を超えた処理はせず、ただエラーを throw するのみ。

- ユースケース層は中心となって各層のエラーを受け止め、適切に変換して controller に渡す。

- controller 層は、アプリ外部との境界なので、最終的にユーザーに意味ある形でレスポンスを返す。



| 層                | 例外を投げる | 例外をキャッチ | 備考                                                                          |
| ---------------- | ------ | ------- | --------------------------------------------------------------------------- |
| **ドメイン層**        | ✅      | ❌       | 自層のルール違反（バリデーションなど）で `DomainError` を `throw`。キャッチはしない。                      |
| **インフラ層**        | ✅      | ❌       | 通信エラーや外部APIの不正などで `InfraError` を `throw`。キャッチはしない。                          |
| **ユースケース層**      | ✅      | ✅       | ドメイン/インフラのエラーを `catch` → `ApplicationError` に変換して再スロー。自身のエラー（業務ロジック違反）も投げる。 |
| **コントローラー層**     | ❌（原則）  | ✅       | 最終 `catch` 担当。ユースケースからの `ApplicationError` を HTTP レスポンスに変換。                 |
| **main/server層** | ✅      | ✅       | 初期化系の `Error` を自前で `try-catch` → `exit(1)` やログ出力。                           |



#### 2. エラー処理のテスト

| 層                   | エラー発生          | エラー検出の観点例                                    | テスト種別                       |
| ------------------- | -------------- | -------------------------------------------- | --------------------------- |
| ドメイン                | バリデーション        | ・不正な値でオブジェクト生成不可<br>・値オブジェクトの制約違反            | ユニットテスト（ドメインモデル単体）          |
| インフラ                | DB/API通信エラー    | ・DB接続失敗<br>・期待しない戻り値<br>・タイムアウト              | インテグレーションテスト（外部接続あり）        |
| ユースケース              | ビジネスルール違反      | ・存在しないID指定<br>・ドメインからのエラー<br>・インフラ層の失敗を適切に処理 | ユースケース層テスト（リポジトリなどはモック）     |
| controller          | 最終的な catch     | ・エラー種に応じたステータスコードとメッセージ<br>・正常/異常の分岐         | E2Eテスト or APIテスト            |
| main.ts / server.ts | システム初期化時の重大エラー | ・ポートが使われてる<br>・起動前の例外発生                      | 起動スクリプトのテスト（シェル or スモークテスト） |
